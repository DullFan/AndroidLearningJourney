# æ³¨è§£

åˆ›å»ºæ—¶é—´: February 24, 2023 12:43 AM
æ ‡ç­¾: Java

# æ¦‚å¿µ

Java æ³¨è§£ï¼ˆAnnotationï¼‰åˆç§° Java æ ‡æ³¨ï¼Œæ˜¯ JDK5.0 å¼•å…¥çš„ä¸€ç§æ³¨é‡Šæœºåˆ¶ã€‚ æ³¨è§£æ˜¯å…ƒæ•°æ®çš„ä¸€ç§å½¢å¼ï¼Œæä¾›æœ‰å…³äºç¨‹åºä½†ä¸å±äºç¨‹åºæœ¬èº«çš„æ•°æ®ã€‚æ³¨è§£å¯¹å®ƒä»¬æ³¨è§£çš„ä»£ç çš„æ“ä½œæ²¡æœ‰ç›´æ¥å½±å“ã€‚

æ³¨è§£æœ¬èº«æ²¡æœ‰ä»»ä½•æ„ä¹‰,å•ç‹¬çš„æ³¨è§£å°±æ˜¯ä¸€ç§æ³¨é‡Š,å®ƒéœ€è¦ç»“åˆå…¶ä»–æŠ€æœ¯(åå°„,æ’æ¡©ç­‰)æ‰æœ‰æ„ä¹‰ã€‚

javaä¸­æ‰€æœ‰çš„æ³¨è§£,é»˜è®¤å®ç°Annotationæ¥å£:

```java
package java.lang.annotation;
public interface Annotation {
    boolean equals(Object obj);
    int hashCode();
    String toString();
    Class<? extends Annotation> annotationType();
}
```

ä¸`class`ä¸åŒçš„æ˜¯,æ³¨è§£çš„å£°æ˜ä½¿ç”¨`@interface`å…³é”®å­—.ä¸€ä¸ªæ³¨è§£çš„å£°æ˜å¦‚ä¸‹:

```java
public @interface DullFan{}
```

# Javaè‡ªå¸¦çš„æ³¨è§£

- @Override - æ£€æŸ¥è¯¥æ–¹æ³•æ˜¯å¦æ˜¯é‡å†™æ–¹æ³•ã€‚å¦‚æœå‘ç°å…¶çˆ¶ç±»ï¼Œæˆ–è€…æ˜¯å¼•ç”¨çš„æ¥å£ä¸­å¹¶æ²¡æœ‰è¯¥æ–¹æ³•æ—¶ï¼Œä¼šæŠ¥ç¼–è¯‘é”™è¯¯ã€‚
- @Deprecated - æ ‡è®°è¿‡æ—¶æ–¹æ³•ã€‚å¦‚æœä½¿ç”¨è¯¥æ–¹æ³•ï¼Œä¼šæŠ¥ç¼–è¯‘è­¦å‘Šã€‚
- @SuppressWarnings - æŒ‡ç¤ºç¼–è¯‘å™¨å»å¿½ç•¥æ³¨è§£ä¸­å£°æ˜çš„è­¦å‘Šã€‚

# å…ƒæ³¨è§£

åœ¨å®šä¹‰æ³¨è§£æ—¶,æ³¨è§£ç±»ä¹Ÿèƒ½å¤Ÿä½¿ç”¨å…¶ä»–æ³¨è§£å£°æ˜,å¯¹æ³¨è§£ç±»å‹è¿›è¡Œæ³¨è§£çš„æ³¨è§£,ç§°ä¸º`meta-annottion(å…ƒæ³¨è§£)`.åœ¨å®šä¹‰è‡ªå®šä¹‰æ³¨è§£æ—¶,éœ€è¦æŒ‡å®šçš„å…ƒæ³¨è§£æœ‰ä¸¤ä¸ª: `@Target` å’Œ `@Retention`

## @Target(ç›®æ ‡)

æ³¨è§£æ ‡è®°å¦ä¸€ä¸ªæ³¨è§£,é™åˆ¶ä½¿ç”¨åœºæ™¯

`@Target`æœ‰ä¸‹é¢çš„å–å€¼:

- `ElementType.ANNOTATION_TYPE`ï¼šå¯ä»¥ç»™ä¸€ä¸ªæ³¨è§£è¿›è¡Œæ³¨è§£ã€‚
- `ElementType.CONSTRUCTOR`ï¼šå¯ä»¥ç»™æ„é€ æ–¹æ³•è¿›è¡Œæ³¨è§£ã€‚
- `ElementType.FIELD`ï¼šå¯ä»¥ç»™å±æ€§è¿›è¡Œæ³¨è§£ã€‚
- `ElementType.LOCAL_VARIABLE`ï¼šå¯ä»¥ç»™å±€éƒ¨å˜é‡è¿›è¡Œæ³¨è§£ã€‚
- `ElementType.METHOD`ï¼šå¯ä»¥ç»™æ–¹æ³•è¿›è¡Œæ³¨è§£ã€‚
- `ElementType.PACKAGE`ï¼šå¯ä»¥ç»™ä¸€ä¸ªåŒ…è¿›è¡Œæ³¨è§£ã€‚
- `ElementType.PARAMETER`ï¼šå¯ä»¥ç»™ä¸€ä¸ªæ–¹æ³•å†…çš„å‚æ•°è¿›è¡Œæ³¨è§£ã€‚
- `ElementType.TYPE`ï¼šå¯ä»¥ç»™ä¸€ä¸ªç±»å‹è¿›è¡Œæ³¨è§£ï¼Œæ¯”å¦‚ç±»ã€æ¥å£ã€æšä¸¾ã€‚
- `ElementType.TYPE_USE`ï¼š1.8ç‰ˆæœ¬æ–°å¢,å¯ä»¥ç”¨äºä»»ä½•ä½¿ç”¨ç±»å‹çš„è¯­å¥ä¸­ã€‚
- `ElementType.TYPE_PARAMETER`ï¼š1.8ç‰ˆæœ¬æ–°å¢,å¯ä»¥ç”¨äºç±»å‹å˜é‡
- `ElementType.MODULE`ï¼š *9ç‰ˆæœ¬æ–°å¢,å¯ä»¥ç”¨äºæ¨¡å—å£°æ˜*

## @Retention(å­˜æ´»æ—¶é—´)

æ³¨è§£æŒ‡å®šæ ‡è®°æ³¨è§£çš„å­˜å‚¨æ–¹å¼

- `RetentionPolicy.SOURCE` - æ ‡è®°çš„æ³¨è§£ä»…ä¿ç•™åœ¨æºç ä¸Šï¼Œåœ¨ç¼–è¯‘æ—¶ä¼šè¢«ç¼–è¯‘å™¨ä¸¢å¼ƒã€‚
- `RetentionPolicy.CLASS` - æ³¨è§£ä¼šè¢«ä¿ç•™åœ¨Classæ–‡ä»¶ä¸­ï¼Œä½†ä¸ä¼šè¢«åŠ è½½åˆ° Java è™šæ‹Ÿæœº(JVM) ä¸­ï¼Œè¿è¡Œæ—¶æ— æ³•è·å¾—ã€‚(é»˜è®¤çº§åˆ«)
- `RetentionPolicy.RUNTIME` - æ³¨è§£ä¼šè¢«ä¿ç•™åœ¨Classæ–‡ä»¶ä¸­ï¼Œä¸”ä¼šè¢«åŠ è½½åˆ°è™šæ‹Ÿæœºä¸­ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶è·å¾—ã€‚

@Retention ä¸‰ä¸ªå€¼ä¸­ SOURCE < CLASS < RUNTIMEï¼Œå³CLASSåŒ…å«äº†SOURCEï¼ŒRUNTIMEåŒ…å«SOURCEã€CLASSã€‚

<aside>
âš ï¸ Androidæ‰“åŒ…ä¸º`.dex`æ–‡ä»¶,`class`çº§åˆ«æ³¨è§£ä¼šè¢«æŠ›å¼ƒ

### ä½¿ç”¨åœºæ™¯

æŒ‰ç…§`@Retention` å…ƒæ³¨è§£å®šä¹‰çš„æ³¨è§£å­˜å‚¨æ–¹å¼ï¼Œæ³¨è§£å¯ä»¥è¢«åœ¨ä¸‰ç§åœºæ™¯ä¸‹ä½¿ç”¨ï¼š

**SOURCE**

RetentionPolicy.SOURCEï¼Œä½œç”¨äºæºç çº§åˆ«çš„æ³¨è§£ï¼Œå¯æä¾›ç»™IDEè¯­æ³•æ£€æŸ¥ã€APTç­‰åœºæ™¯ä½¿ç”¨ã€‚åœ¨ç±»ä¸­ä½¿ç”¨ SOURCE çº§åˆ«çš„æ³¨è§£ï¼Œå…¶ç¼–è¯‘ä¹‹åçš„classä¸­ä¼šè¢«ä¸¢å¼ƒã€‚

æ­¤æ³¨è§£çš„æ„ä¹‰åœ¨äºèƒ½å¤Ÿå–ä»£æšä¸¾ï¼Œå®ç°å¦‚æ–¹æ³•å…¥å‚é™åˆ¶ã€‚

Javaä¸­Enum(æšä¸¾)çš„æœ¬è´¨æ˜¯ç‰¹æ®Šå•ä¾‹çš„é™æ€æˆå‘˜å˜é‡ï¼Œåœ¨è¿è¡ŒæœŸæ‰€æœ‰æšä¸¾ç±»ä½œä¸ºå•ä¾‹ï¼Œå…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ã€‚æ¯”å¸¸é‡å¤š5åˆ°10å€çš„å†…å­˜å ç”¨ã€‚

ä»£ç ç¤ºä¾‹ï¼š

```java
@IntDef({Flag.FLAG01, Flag.FLAG02})
@Target(ElementType.PARAMETER)
@Retention(RetentionPolicy.SOURCE)
@interface flag {
}

class Flag {
    public static final int FLAG01 = 1;
    public static final int FLAG02 = 2;
}
//æ­¤æ³¨è§£çš„æ„ä¹‰åœ¨äºèƒ½å¤Ÿå–ä»£æšä¸¾ï¼Œå®ç°å¦‚æ–¹æ³•å…¥å‚é™åˆ¶ã€‚
@Retention(SOURCE)
@Target({ANNOTATION_TYPE})
public @interface IntDef {
    int[] value() default {};
		
    boolean flag() default false;
		
    boolean open() default false;
}

public class MainActivity extends AppCompatActivity {
    TextView textView;
    Button button01, button02;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        initView();
        button01.setOnClickListener(v -> flagTest(Flag.FLAG01));

        button02.setOnClickListener(v -> flagTest(Flag.FLAG02));
    }

    private void initView() {
        textView = findViewById(R.id.main_text);
        button01 = findViewById(R.id.main_button01);
        button02 = findViewById(R.id.main_button02);
    }

    private void flagTest(@flag int flag) {
        if (flag == Flag.FLAG01) {
            textView.setText("é€‰é¡¹ä¸€");
        } else if (flag == Flag.FLAG02) {
            textView.setText("é€‰é¡¹äºŒ");
        }
    }

}
```

æ•ˆæœå›¾ï¼š

![Untitled](%E6%B3%A8%E8%A7%A3%203754c1f218474b69ac8425aced366de1/Untitled.png)

å¦‚æœä¼ å…¥çš„å€¼ä¸æ˜¯FLAG01 æˆ– FLAG02 é‚£ä¹ˆç¼–è¯‘å™¨ä¼šæé†’ä½ å€¼åªèƒ½æœ‰è¿™ä¸¤ä½,ä½†æ˜¯è¿™ä¸ªæ˜¯ç¼–è¯‘è­¦å‘Š,ä¸ä¼šå½±å“ç¨‹åºçš„è¿è¡Œã€‚

![Untitled](%E6%B3%A8%E8%A7%A3%203754c1f218474b69ac8425aced366de1/Untitled%201.png)

**CLASS**

å®šä¹‰ä¸º CLASSçš„æ³¨è§£ï¼Œä¼šä¿ç•™åœ¨classæ–‡ä»¶ä¸­ï¼Œä½†æ˜¯ä¼šè¢«è™šæ‹Ÿæœºå¿½ç•¥(å³æ— æ³•åœ¨è¿è¡ŒæœŸåå°„è·å–æ³¨è§£)ã€‚æ­¤æ—¶å®Œå…¨ç¬¦åˆæ­¤ç§æ³¨è§£çš„åº”ç”¨åœºæ™¯ä¸ºå­—èŠ‚ç æ“ä½œã€‚å¦‚ï¼šAspectJã€çƒ­ä¿®å¤Roubustä¸­åº”ç”¨æ­¤åœºæ™¯ã€‚æ‰€è°“å­—èŠ‚ç æ“ä½œå³ä¸ºï¼Œç›´æ¥ä¿®æ”¹å­—èŠ‚ç Classæ–‡ä»¶ä»¥è¾¾åˆ°ä¿®æ”¹ä»£ç æ‰§è¡Œé€»è¾‘çš„ç›®çš„ã€‚åœ¨ç¨‹åºä¸­æœ‰å¤šå¤„éœ€è¦è¿›è¡Œæ˜¯å¦ç™»å½•çš„åˆ¤æ–­ã€‚

<aside>
ğŸ’¡ **å­—èŠ‚ç å¢å¼º:åœ¨å­—èŠ‚ç ä¸­å†™ä»£ç **

å­—èŠ‚ç å¢å¼ºæŠ€æœ¯ç›¸å½“äºæ˜¯ä¸€æŠŠæ‰“å¼€è¿è¡Œæ—¶JVMçš„é’¥åŒ™ï¼Œåˆ©ç”¨å®ƒå¯ä»¥åŠ¨æ€åœ°å¯¹è¿è¡Œä¸­çš„ç¨‹åºåšä¿®æ”¹ï¼Œä¹Ÿå¯ä»¥è·Ÿè¸ªJVMè¿è¡Œä¸­ç¨‹åºçš„çŠ¶æ€ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„åŠ¨æ€ä»£ç†ã€AOPä¹Ÿä¸å­—èŠ‚ç å¢å¼ºå¯†åˆ‡ç›¸å…³ï¼Œå®ƒä»¬å®è´¨ä¸Šè¿˜æ˜¯åˆ©ç”¨å„ç§æ‰‹æ®µç”Ÿæˆæˆ–ä¿®æ”¹ç¬¦åˆè§„èŒƒçš„å­—èŠ‚ç æ–‡ä»¶ã€‚ç»¼ä¸Šæ‰€è¿°ï¼ŒæŒæ¡å­—èŠ‚ç å¢å¼ºåå¯ä»¥é«˜æ•ˆåœ°å®šä½å¹¶å¿«é€Ÿä¿®å¤ä¸€äº›æ£˜æ‰‹çš„é—®é¢˜ï¼ˆå¦‚çº¿ä¸Šæ€§èƒ½é—®é¢˜ã€æ–¹æ³•å‡ºç°ä¸å¯æ§çš„å‡ºå…¥å‚éœ€è¦ç´§æ€¥åŠ æ—¥å¿—ç­‰é—®é¢˜ï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨å¼€å‘ä¸­å‡å°‘å†—ä½™ä»£ç ï¼Œå¤§å¤§æé«˜å¼€å‘æ•ˆç‡ã€‚

å…·ä½“å¯ä»¥æŸ¥çœ‹:

[https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html](https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html)

![https://cdn.nlark.com/yuque/0/2022/png/26240361/1645679033924-47380606-1d74-4fa4-9750-a922a72b34b9.png](https://cdn.nlark.com/yuque/0/2022/png/26240361/1645679033924-47380606-1d74-4fa4-9750-a922a72b34b9.png)

**RUNTIME**

æ³¨è§£ä¿ç•™è‡³è¿è¡ŒæœŸï¼Œæ„å‘³ç€æˆ‘ä»¬èƒ½å¤Ÿåœ¨è¿è¡ŒæœŸé—´ç»“åˆåå°„æŠ€æœ¯è·å–æ³¨è§£ä¸­çš„æ‰€æœ‰ä¿¡æ¯ã€‚

## @Documented(æ–‡æ¡£)

ç”Ÿæˆæ–‡æ¡£ä¿¡æ¯çš„æ—¶å€™ä¿ç•™æ³¨è§£ï¼Œå¯¹ç±»ä½œè¯´æ˜

## @Repeatable(é‡å¤)

ç”¨äºå£°æ˜æ ‡è®°çš„æ³¨è§£ä¸ºå¯é‡å¤ç±»å‹æ³¨è§£ï¼Œå¯ä»¥åœ¨åŒä¸€ä¸ªåœ°æ–¹å¤šæ¬¡ä½¿ç”¨

```java
@Documented
@interface Students {
    Student[] value();
}

@Documented
@Repeatable(Students.class)
@interface Student {
    // .....
}
```

## @Inherited(ç»§æ‰¿)

ç”¨äºæŒ‡æ˜çˆ¶ç±»æ³¨è§£ä¼šè¢«å­ç±»ç»§æ‰¿å¾—åˆ°

## ä»£ç ç¤ºä¾‹

```java
//@Target(ElementType.TYPE) åªèƒ½åœ¨ç±»ä¸Šæ ‡è®°è¯¥æ³¨è§£
@Target({ElementType.TYPE,ElementType.FIELD}) // å…è®¸åœ¨ç±»ä¸ç±»å±æ€§ä¸Šæ ‡è®°è¯¥æ³¨è§£
@Retention(RetentionPolicy.SOURCE) //æ³¨è§£ä¿ç•™åœ¨æºç ä¸­
public @interface DullFan{}
```

åœ¨è¿™é‡Œå¯ä»¥æŸ¥çœ‹.classæ–‡ä»¶

![https://cdn.nlark.com/yuque/0/2022/png/26240361/1645678638418-03ff9002-efa1-46b8-b36c-bc2ad90c3a97.png](https://cdn.nlark.com/yuque/0/2022/png/26240361/1645678638418-03ff9002-efa1-46b8-b36c-bc2ad90c3a97.png)

# æ³¨è§£ç±»å‹å…ƒç´ 

åœ¨ä½¿ç”¨æ³¨è§£æ—¶å¯ä»¥ä¼ é€’å‚æ•°

```java
@Target({ElementType.TYPE,ElementType.FIELD})
//å¦‚æœéœ€è¦ä½¿ç”¨åå°„å°±å¿…é¡»è¦ä½¿ç”¨RUNTIMEæ ‡æ³¨ã€‚
@Retention(RetentionPolicy.RUNTIME)
@interface User{
    //æ— é»˜è®¤å€¼
    String name();
    //æœ‰é»˜è®¤å€¼
    int age() default 1;
}
```

æ³¨æ„ï¼šåœ¨ä½¿ç”¨æ³¨è§£æ—¶ï¼Œå¦‚æœå®šä¹‰çš„æ³¨è§£ä¸­çš„ç±»å‹å…ƒç´ æ— é»˜è®¤å€¼ï¼Œåˆ™å¿…é¡»è¿›è¡Œä¼ å€¼ã€‚

```java
//å¦‚æœè¯¥æ³¨è§£åªæœ‰ä¸€ä¸ªå‚æ•°çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥çœç•¥: å…ƒç´ å =
@User(name = "DullFan")
int i;
```

å¦‚æœè¦è·å–è¯¥å€¼å°±è¦ä½¿ç”¨åå°„äº†,ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java

try {
		//è·å¾—ç±»å£°æ˜çš„å‘½åçš„å­—æ®µ
    Field field = MainActivity.class.getDeclaredField("age");
		//è·å¾—æ³¨è§£
    User annotation = field.getAnnotation(User.class);
    Log.e("TAG", "onCreate: "+field);
    Log.e("TAG", "onCreate: "+annotation);
		//ç„¶åæ‰“å°å³å¯
    String name = annotation.name();
    int age = annotation.age();
    Log.e("TAG", "onCreate: "+name );
    Log.e("TAG", "onCreate: "+age );
} catch (NoSuchFieldException e) {
    e.printStackTrace();
}
```

è¾“å‡ºç»“æœï¼š

![Untitled](%E6%B3%A8%E8%A7%A3%203754c1f218474b69ac8425aced366de1/Untitled%202.png)

# APTæ³¨è§£å¤„ç†å™¨

APTå…¨ç§°ä¸ºï¼š"Anotation Processor Tools"ï¼Œæ„ä¸ºæ³¨è§£å¤„ç†å™¨ï¼ŒAPTæ˜¯javacçš„ä¸€ä¸ªå·¥å…·ï¼ŒAPTå¯ä»¥ç”¨æ¥åœ¨ç¼–è¯‘æœŸé—´æ‰«æå’Œå¤„ç†æ³¨è§£ã€‚é€šè¿‡APTå¯ä»¥è·å–æ³¨è§£å’Œå¤‡æ³¨è§£çš„ç›¸å…³ä¿¡æ¯ï¼Œé€šè¿‡è¿™äº›ä¿¡æ¯åŠ¨æ€çš„ç”Ÿæˆä»£ç çœå»æ‰‹åŠ¨ç¼–å†™ã€‚åå°„æ˜¯åœ¨è¿è¡Œæ—¶å¤„ç†æ³¨è§£ï¼Œç›¸æ¯”åå°„APTæ•ˆç‡æ›´é«˜ã€‚APTçš„æ ¸å¿ƒç±»çš„æ˜¯AbstractProcessorã€‚ï¼ˆè¯´ç™½äº†å°±æ˜¯åœ¨ç¼–è¯‘æœŸçš„æ—¶å€™å¯ä»¥åœ¨ä¸­é—´å¹²ä»»ä½•äº‹æƒ…ï¼‰

æ³¨è§£å¤„ç†å™¨æ˜¯å¯¹æ³¨è§£åº”ç”¨æœ€ä¸ºå¹¿æ³›çš„åœºæ™¯ã€‚åœ¨Glideã€EventBus3ã€Butterkniferã€Tinkerã€ARouterç­‰ç­‰å¸¸ç”¨æ¡†æ¶ä¸­éƒ½æœ‰æ³¨è§£å¤„ç†å™¨çš„èº«å½±ã€‚ä½†æ˜¯ä½ å¯èƒ½ä¼šå‘ç°ï¼Œè¿™äº›æ¡†æ¶ä¸­å¯¹æ³¨è§£çš„å®šä¹‰å¹¶ä¸æ˜¯ SOURCEçº§åˆ«ï¼Œæ›´å¤šçš„æ˜¯ CLASS çº§åˆ«ï¼Œåˆ«å¿˜äº†ï¼šCLASSåŒ…å«äº†SOURCEï¼ŒRUNTIMEåŒ…å«SOURCEã€CLASSã€‚

åŸç†: ç¼–å†™å¥½çš„ Java æºæ–‡ä»¶ï¼Œéœ€è¦ç»è¿‡ javac çš„ç¼–è¯‘ï¼Œç¿»è¯‘ä¸ºè™šæ‹Ÿæœºèƒ½å¤ŸåŠ è½½è§£æçš„å­—èŠ‚ç  Class æ–‡ä»¶ã€‚æ³¨è§£å¤„ç†å™¨æ˜¯ javac è‡ªå¸¦çš„ä¸€ä¸ªå·¥å…·ï¼Œç”¨æ¥åœ¨ç¼–è¯‘æ—¶æœŸæ‰«æå¤„ç†æ³¨è§£ä¿¡æ¯ã€‚ä½ å¯ä»¥ä¸ºæŸäº›æ³¨è§£æ³¨å†Œè‡ªå·±çš„æ³¨è§£å¤„ç†å™¨ã€‚ æ³¨å†Œçš„æ³¨è§£å¤„ç†å™¨ç”± javacè°ƒèµ·ï¼Œå¹¶å°†æ³¨è§£ä¿¡æ¯ä¼ é€’ç»™æ³¨è§£å¤„ç†å™¨è¿›è¡Œå¤„ç†ã€‚	

<aside>
ğŸ“ Demoçš„APTæ— æ³•æ‰“å°æ—¥å¿—ï¼Œæäº†åŠå¤©ä¹Ÿæ— æ³•è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒDemoç•™ä¸ªå‘ä»¥åæœ‰åŠæ³•å†æ¥è§£å†³ï¼Œå…·ä½“çš„ä»£ç å¯ä»¥çœ‹
[Android APT ç³»åˆ— ï¼ˆä¸‰ï¼‰ï¼šAPT æŠ€æœ¯æ¢ç©¶ - æ˜é‡‘](https://juejin.cn/post/6978500975770206239#comment)
Demoåœ°å€ï¼š[APTAnnotationDemo](../Demo/APTAnnotationDemo)

## ä½œç”¨

ä½¿ç”¨APTå¯ä»¥åœ¨ç¼–è¯‘æ—¶æ¥å¤„ç†ç¼–è¯‘æ—¶æ³¨è§£ï¼Œç”Ÿæˆé¢å¤–çš„Javaæ–‡ä»¶ï¼Œæœ‰å¦‚ä¸‹æ•ˆæœï¼š

1. å¯ä»¥è¾¾åˆ°å‡å°‘é‡å¤ä»£ç æ‰‹å·¥ç¼–å†™çš„æ•ˆæœã€‚
   
    > å¦‚ButterKnifeï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨æ³¨è§£æ¥å‡å°‘findviewbyidè¿™äº›ä»£ç ï¼Œåªéœ€è¦é€šè¿‡æ³¨è§£è¡¨ç¤ºæ˜¯å“ªä¸ªidå°±å¤Ÿäº†ã€‚
    > 
2. åŠŸèƒ½å°è£…ã€‚å°†ä¸»è¦çš„åŠŸèƒ½é€»è¾‘å°è£…èµ·æ¥ï¼Œåªä¿ç•™æ³¨è§£è°ƒç”¨ã€‚
3. ç›¸å¯¹äºä½¿ç”¨Javaåå°„æ¥å¤„ç†è¿è¡Œæ—¶æ³¨è§£ï¼Œä½¿ç”¨APTæœ‰ç€æ›´åŠ è‰¯å¥½çš„æ€§èƒ½ã€‚

## AndroidåŸºæœ¬ç¼–è¯‘æµç¨‹

Androidä¸­çš„ä»£ç ç¼–è¯‘æ—¶éœ€è¦ç»è¿‡ï¼šJava â€”â€”> javac â€”â€”> class â€”â€”> dex æµç¨‹ï¼Œä»£ç æœ€ç»ˆç”Ÿæˆdexæ–‡ä»¶æ‰“å…¥åˆ°APKåŒ…é‡Œé¢ã€‚

ç¼–è¯‘æµç¨‹å¦‚å›¾æ‰€ç¤ºï¼š

![Untitled](%E6%B3%A8%E8%A7%A3%203754c1f218474b69ac8425aced366de1/Untitled%203.png)

1ã€APTæ˜¯åœ¨ç¼–è¯‘å¼€å§‹æ—¶å°±ä»‹å…¥çš„ï¼Œä¹Ÿå°±æ˜¯javaåˆ°classçš„è¿™ä¸ªè¿‡ç¨‹ï¼Œç”¨æ¥å¤„ç†ç¼–è¯‘æ—¶æ³¨è§£ã€‚

2ã€AOPï¼ˆAspect Oridnted Programmingï¼‰æ˜¯åœ¨ç¼–è¯‘å®Œæˆåç”Ÿæˆdexæ–‡ä»¶ä¹‹å‰ï¼Œé€šè¿‡ç›´æ¥ä¿®æ”¹.classæ–‡ä»¶çš„æ–¹å¼ï¼Œæ¥å¯¹ä»£ç è¿›è¡Œä¿®æ”¹æˆ–æ·»åŠ é€»è¾‘ã€‚å¸¸ç”¨åœ¨åœ¨ä»£ç ç›‘æ§ï¼Œä»£ç ä¿®æ”¹ï¼Œä»£ç åˆ†æè¿™äº›åœºæ™¯ã€‚

<aside>
âš ï¸ APTä¸ä¼šæ‰“åŒ…è¿›å…¥APKï¼Œåªä¼šåœ¨ç¼–è¯‘æ—¶å‚ä¸ç¼–è¯‘
## ä»€ä¹ˆæ˜¯ç¼–è¯‘æœŸï¼Ÿ

ç¨‹åºå¤§æ¦‚å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªæ—¶æœŸï¼š

1. æºç æœŸï¼Œå¼€å‘æ—¶ç¼–å†™çš„Java æˆ– kotlinä»£ç 
2. ç¼–è¯‘æœŸï¼Œjava æˆ– kotlinä»£ç  ç¼–è¯‘æˆ classå­—èŠ‚ç æ–‡ä»¶
3. è¿è¡ŒæœŸï¼Œç¨‹åºè¿è¡Œ ï¼Œå­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°Javaè™šæ‹Ÿæœºä¸­

**ç¼–è¯‘æœŸ å°±æ˜¯ javaæºç  åˆ° classå­—èŠ‚ç çš„è¿‡ç¨‹  `xxx.java â€” xxx.class`  ç”±javacå·¥å…·å®ç°**

## åŸºæœ¬ä½¿ç”¨

### APIå·¥ç¨‹åˆ›å»º

åˆ›å»ºä¸‰ä¸ªModule

1. annotationsï¼šç¼–å†™æ³¨è§£ï¼ˆéœ€è¦ä½¿ç”¨Javaçš„Libï¼‰
2. compilerï¼šç”¨æ¥è¯»å–æ³¨è§£ä¿¡æ¯ï¼Œå¹¶æ ¹æ®æŒ‡å®šè§„åˆ™ï¼Œç”Ÿæˆç›¸åº”çš„ç±»æ–‡ä»¶ï¼ˆéœ€è¦ä½¿ç”¨Javaçš„Libï¼‰
3. apiï¼šé€šè¿‡åå°„è·å–ç”Ÿæˆçš„ç±»ï¼Œè¿›è¡Œåˆç†çš„å°è£…ï¼Œæä¾›ç»™ä¸Šå±‚è°ƒç”¨

å¦‚ä¸‹å›¾ï¼š

![Untitled](%E6%B3%A8%E8%A7%A3%203754c1f218474b69ac8425aced366de1/Untitled%204.png)

### Moduleä¾èµ–

åˆ›å»ºå¥½ä¹‹åéœ€è¦æ·»åŠ å„ä¸ªModuleä¹‹é—´çš„ä¾èµ–å…³ç³»

1. `compiler`éœ€è¦è¯»å–`annotations`ä¸­çš„æ³¨è§£,æ‰€ä»¥compileréœ€è¦ä¾èµ–annotations
   
    ```kotlin
    //compiler çš„ build.gradle æ–‡ä»¶
    dependencies {
        implementation project(":annotations")
    			........
    }
    ```
    
2. `app`ä½œä¸ºè°ƒç”¨å±‚ï¼Œéœ€è¦å¯¹ä»¥ä¸Šä¸‰ä¸ªæ¨¡å—è¿›è¡Œä¾èµ–
   
    ```kotlin
    //app çš„ build.gradle æ–‡ä»¶
    dependencies {
        implementation project(":annotations")
        implementation project(":compiler")
        implementation project(":api")
    			........
    }
    ```
    

### annotations ç¼–å†™

è¿™é‡Œç›´æ¥å†™è‡ªå®šä¹‰æ³¨è§£å°±å¯ä»¥äº†

```kotlin
@Retention(RetentionPolicy.SOURCE)
@Inherited
@Documented
@Target({ElementType.TYPE,ElementType.METHOD})
public @interface AptAnnotation {
    String desc() default "";
}
```

### compiler ç¼–å†™

åˆ†ä¸ºä¸‰æ­¥ï¼š

1. æ³¨è§£å¤„ç†å™¨å£°æ˜
2. æ³¨è§£å¤„ç†å™¨æ³¨å†Œ
3. æ³¨è§£å¤„ç†å™¨ç”Ÿæˆç±»æ–‡ä»¶

**æ³¨è§£å¤„ç†å™¨å£°æ˜**

åˆ›å»ºä¸€ä¸ªç±»,ç»§æ‰¿`javax.annotation.processing.AbstractProcessor`åŒ…ä¸‹çš„`AbstractProcessor`ç±»å¹¶å®ç°æŠ½è±¡æ–¹æ³•

```kotlin
public class AnnotationCompiler extends AbstractProcessor {
    
    /**
     * ç¼–å†™ç”Ÿæˆ Java ç±»çš„ç›¸å…³é€»è¾‘
     *
     * @param annotations æ”¯æŒå¤„ç†çš„æ³¨è§£é›†åˆ
     * @param roundEnv é€šè¿‡è¯¥å¯¹è±¡æŸ¥æ‰¾æŒ‡å®šæ³¨è§£ä¸‹çš„èŠ‚ç‚¹ä¿¡æ¯
     * @return true: è¡¨ç¤ºæ³¨è§£å·²å¤„ç†ï¼Œåç»­æ³¨è§£å¤„ç†å™¨æ— éœ€å†å¤„ç†å®ƒä»¬ï¼›false: è¡¨ç¤ºæ³¨è§£æœªå¤„ç†ï¼Œå¯èƒ½è¦æ±‚åç»­æ³¨è§£å¤„ç†å™¨å¤„ç†
     */
    @Override
    public boolean process(Set<? extends TypeElement> annotations, RoundEnvironment roundEnv) {

        return false;
    }
}
```

é‡ç‚¹çœ‹ä¸‹ç¬¬ä¸€ä¸ªå‚æ•°ä¸­çš„ TypeElement ï¼Œè¿™ä¸ªå°±æ¶‰åŠåˆ° Element çš„çŸ¥è¯†

<aside>
ğŸ“ **Element ä»‹ç»**
å®é™…ä¸Šï¼ŒJava æºæ–‡ä»¶æ˜¯ä¸€ç§ç»“æ„ä½“è¯­è¨€ï¼Œæºä»£ç çš„æ¯ä¸€ä¸ªéƒ¨åˆ†éƒ½å¯¹åº”äº†ä¸€ä¸ªç‰¹å®šç±»å‹çš„ Element ï¼Œä¾‹å¦‚åŒ…ï¼Œç±»ï¼Œå­—æ®µï¼Œæ–¹æ³•ç­‰ç­‰ï¼š

```kotlin
package com.dream;         // PackageElementï¼šåŒ…å…ƒç´ 

public class Main<T> {     // TypeElementï¼šç±»å…ƒç´ ; å…¶ä¸­ <T> å±äº TypeParameterElement æ³›å‹å…ƒç´ 

    private int x;         // VariableElementï¼šå˜é‡ã€æšä¸¾ã€æ–¹æ³•å‚æ•°å…ƒç´ 

    public Main() {        // ExecutableElementï¼šæ„é€ å‡½æ•°ã€æ–¹æ³•å…ƒç´ 
    }
}
```

Java çš„ Element æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæºç å¦‚ä¸‹ï¼š

```kotlin
public interface Element extends javax.lang.model.AnnotatedConstruct {
    // è·å–å…ƒç´ çš„ç±»å‹ï¼Œå®é™…çš„å¯¹è±¡ç±»å‹
    TypeMirror asType();
    // è·å–Elementçš„ç±»å‹ï¼Œåˆ¤æ–­æ˜¯å“ªç§Element
    ElementKind getKind();
    // è·å–ä¿®é¥°ç¬¦ï¼Œå¦‚public static finalç­‰å…³é”®å­—
    Set<Modifier> getModifiers();
    // è·å–ç±»å
    Name getSimpleName();
    // è¿”å›åŒ…å«è¯¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼Œä¸getEnclosedElements()æ–¹æ³•ç›¸å
    Element getEnclosingElement();
    // è¿”å›è¯¥èŠ‚ç‚¹ä¸‹ç›´æ¥åŒ…å«çš„å­èŠ‚ç‚¹ï¼Œä¾‹å¦‚åŒ…èŠ‚ç‚¹ä¸‹åŒ…å«çš„ç±»èŠ‚ç‚¹
    List<? extends Element> getEnclosedElements();

    @Override
    boolean equals(Object obj);
  
    @Override
    int hashCode();
  
    @Override
    List<? extends AnnotationMirror> getAnnotationMirrors();
  
    //è·å–æ³¨è§£
    @Override
    <A extends Annotation> A getAnnotation(Class<A> annotationType);
  
    <R, P> R accept(ElementVisitor<R, P> v, P p);
}
```

é€šè¿‡ Element è·å–å¦‚ä¸Šä¸€äº›ä¿¡æ¯ï¼ˆå†™äº†æ³¨é‡Šçš„éƒ½æ˜¯ä¸€äº›å¸¸ç”¨çš„ï¼‰

ç”± Element è¡ç”Ÿå‡ºæ¥çš„æ‰©å±•ç±»å…±æœ‰ 5 ç§ï¼š

1ã€PackageElement è¡¨ç¤ºä¸€ä¸ªåŒ…ç¨‹åºå…ƒç´ 

2ã€TypeElement è¡¨ç¤ºä¸€ä¸ªç±»æˆ–è€…æ¥å£ç¨‹åºå…ƒç´ 

3ã€TypeParameterElement è¡¨ç¤ºä¸€ä¸ªæ³›å‹å…ƒç´ 

4ã€VariableElement è¡¨ç¤ºä¸€ä¸ªå­—æ®µã€enum å¸¸é‡ã€æ–¹æ³•æˆ–è€…æ„é€ æ–¹æ³•çš„å‚æ•°ã€å±€éƒ¨å˜é‡æˆ–å¼‚å¸¸å‚æ•°

5ã€ExecutableElement è¡¨ç¤ºæŸä¸ªç±»æˆ–è€…æ¥å£çš„æ–¹æ³•ã€æ„é€ æ–¹æ³•æˆ–åˆå§‹åŒ–ç¨‹åºï¼ˆé™æ€æˆ–è€…å®ä¾‹ï¼‰

å¯ä»¥å‘ç°ï¼ŒElement æœ‰æ—¶ä¼šä»£è¡¨å¤šç§å…ƒç´ ï¼Œä¾‹å¦‚ TypeElement ä»£è¡¨ç±»æˆ–æ¥å£ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ element.getKind() æ¥åŒºåˆ†ï¼š

```kotlin
Set<? extends Element> elements = roundEnvironment.getElementsAnnotatedWith(AptAnnotation.class);
for (Element element : elements) {
    if (element.getKind() == ElementKind.CLASS) {
        // å¦‚æœå…ƒç´ æ˜¯ç±»

    } else if (element.getKind() == ElementKind.INTERFACE) {
        // å¦‚æœå…ƒç´ æ˜¯æ¥å£

    }
}
```

ElementKind æ˜¯ä¸€ä¸ªæšä¸¾ç±»ï¼Œå®ƒçš„å–å€¼æœ‰å¾ˆå¤šï¼Œå¦‚ä¸‹ï¼š

```kotlin
PACKAGE	//è¡¨ç¤ºåŒ…
ENUM //è¡¨ç¤ºæšä¸¾
CLASS //è¡¨ç¤ºç±»
ANNOTATION_TYPE	//è¡¨ç¤ºæ³¨è§£
INTERFACE //è¡¨ç¤ºæ¥å£
ENUM_CONSTANT //è¡¨ç¤ºæšä¸¾å¸¸é‡
FIELD //è¡¨ç¤ºå­—æ®µ
PARAMETER //è¡¨ç¤ºå‚æ•°
LOCAL_VARIABLE //è¡¨ç¤ºæœ¬åœ°å˜é‡
EXCEPTION_PARAMETER //è¡¨ç¤ºå¼‚å¸¸å‚æ•°
METHOD //è¡¨ç¤ºæ–¹æ³•
CONSTRUCTOR //è¡¨ç¤ºæ„é€ å‡½æ•°
OTHER //è¡¨ç¤ºå…¶ä»–
```

</aside>

é™¤äº†å¿…é¡»è¦å®ç°çš„æŠ½è±¡æ–¹æ³•,è¿˜æœ‰å…¶ä»–4ä¸ªå¸¸ç”¨çš„æ–¹æ³•

```kotlin
public class AnnotationCompiler extends AbstractProcessor {
    /**
     * èŠ‚ç‚¹å·¥å…·ç±»ï¼ˆç±»ã€å‡½æ•°ã€å±æ€§éƒ½æ˜¯èŠ‚ç‚¹ï¼‰
     */
    private Elements mElementUtils;

    /**
     * ç±»ä¿¡æ¯å·¥å…·ç±»
     */
    private Types mTypeUtils;

    /**
     * æ–‡ä»¶ç”Ÿæˆå™¨
     */
    private Filer mFiler;

    /**
     * æ—¥å¿—ä¿¡æ¯æ‰“å°å™¨
     */
    private Messager mMessager;

    /**
     * åˆå§‹åŒ–
     */
    @Override
    public synchronized void init(ProcessingEnvironment processingEnv) {
        super.init(processingEnv);
        mElementUtils = processingEnv.getElementUtils();
        mTypeUtils = processingEnv.getTypeUtils();
        mFiler = processingEnv.getFiler();
        mMessager = processingEnv.getMessager();
    }

    /**
     * ç¼–è¯‘å½“å‰æ³¨è§£å¤„ç†å™¨çš„ JDK ç‰ˆæœ¬
     *
     * @return JDK ç‰ˆæœ¬
     */
    @Override
    public SourceVersion getSupportedSourceVersion() {
        return SourceVersion.latestSupported();
    }

    /**
     * æ¥æ”¶å¤–æ¥ä¼ å…¥çš„å‚æ•°ï¼Œæœ€å¸¸ç”¨çš„å½¢å¼å°±æ˜¯åœ¨ build.gradle è„šæœ¬æ–‡ä»¶é‡Œçš„ javaCompileOptions çš„é…ç½®
     *
     * @return å±æ€§çš„ Key é›†åˆ
     */
    @Override
    public Set<String> getSupportedOptions() {
        return super.getSupportedOptions();
    }

    /**
     * å½“å‰æ³¨è§£å¤„ç†å™¨æ”¯æŒçš„æ³¨è§£é›†åˆï¼Œå¦‚æœæ”¯æŒï¼Œå°±ä¼šè°ƒç”¨ process æ–¹æ³•
     *
     * @return æ”¯æŒçš„æ³¨è§£é›†åˆ
     */
    @Override
    public Set<String> getSupportedAnnotationTypes() {
        Set<String> types = new HashSet<>();
        types.add(AptAnnotation.class.getCanonicalName());
        return types;
    }
}
```

**æ³¨æ„**ï¼š`getSupportedAnnotationTypes()`ã€`getSupportedSourceVersion()`å’Œ`getSupportedOptions()`Â è¿™ä¸‰ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é‡‡ç”¨æ³¨è§£çš„æ–¹å¼è¿›è¡Œæä¾›ï¼š

```kotlin
@SupportedOptions("MODULE_NAME")
@SupportedAnnotationTypes("com.dullfan.annotations.AptAnnotation")
@SupportedSourceVersion(SourceVersion.RELEASE_8)
public class AnnotationCompiler extends AbstractProcessor
```

**æ³¨è§£å¤„ç†å™¨æ³¨å†Œ**

æ³¨å†Œåˆ†ä¸ºï¼š

1. æ‰‹åŠ¨æ³¨å†Œï¼ˆä»£ç æ˜¯æœ‰ä¹‹å‰çš„é¡¹ç›®æˆªå›¾çš„ï¼Œæ‰‹åŠ¨æ³¨å†Œäº†è§£ä¸€ä¸‹å°±è¡Œï¼‰
   
    åœ¨mainä¸‹é¢åˆ›å»ºä¸€ä¸ªresourcesç›®å½•ï¼Œç„¶ååœ¨resourceç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªMETA-INFç›®å½•ï¼Œåœ¨META-INFç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªservicesç›®å½•ï¼Œåœ¨servicesç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªjavax.annotation.processing.Processor æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­æ”¾æˆ‘ä»¬æ³¨è§£å¤„ç†å™¨çš„å…¨ç±»å(è¿™ä¸ªæ ¼å¼æ—¶å›ºå®šçš„):
    
    ![Untitled](%E6%B3%A8%E8%A7%A3%203754c1f218474b69ac8425aced366de1/Untitled%205.png)
    
    `javax.annotation.processing.Processor` ä¸­çš„ä»£ç 
    
    ```java
    //åœ¨è¿™é‡Œåªè¦å¯ä»¥ç‚¹è¿‡å»å°±ç®—æˆåŠŸ
    com.example.compiler.TestProcessor
    ```
    
2. è‡ªåŠ¨æ³¨å†Œ
   
    ä½¿ç”¨Google autoServiceæ¥è¿›è¡Œæ³¨è§£å¤„ç†å™¨çš„è‡ªåŠ¨æ³¨å†Œï¼Œé¦–å…ˆéœ€è¦åœ¨æ³¨è§£å¤„ç†å™¨æ‰€åœ¨çš„moduleçš„`build.gradle`æ–‡ä»¶æ·»åŠ autoServiceçš„åŒ…å¼•å…¥ï¼š
    
    ```kotlin
    dependencies {
        implementation project(":annotations")
    		//google autoService
        compileOnly "com.google.auto.service:auto-service:1.0-rc7"
        annotationProcessor "com.google.auto.service:auto-service:1.0-rc7"
    }
    ```
    
    ç„¶åå°†`@AutoService(Processor.class)`æ·»åŠ åˆ°æ³¨è§£å¤„ç†å™¨ä¸Šä»¥å®ç°è‡ªåŠ¨æ³¨å†Œæ•ˆæœï¼š
    
    ```kotlin
    @AutoService(Processor.class)
    public class AnnotationCompiler extends AbstractProcessor
    ```
    

**æ³¨è§£å¤„ç†å™¨ç”Ÿæˆç±»æ–‡ä»¶**

ç¼–å†™ç”ŸæˆJavaç±»æ–‡ä»¶çš„ä»£ç ï¼Œå…¶ä¸­ä¹Ÿåˆ†ä¸ºä¸¤ç§æ–¹å¼ï¼š

1. å¸¸è§„çš„å†™æ–‡ä»¶æ–¹æ³•ï¼ˆè¿™ç§æ–¹å¼å¾ˆæ­»æ¿ï¼Œç›¸å½“äºåœ¨è®°äº‹æœ¬å†™ä»£ç ï¼Œä¸æ¨èä½¿ç”¨ï¼‰
2. é€šè¿‡javapoetæ¡†æ¶æ¥ç¼–å†™
   
    è¿™ç§æ–¹å¼æ›´åŠ ç¬¦åˆé¢å‘å¯¹è±¡ç¼–ç çš„ä¸€ä¸ªé£æ ¼ï¼Œå¯¹ javapoet è¿˜ä¸ç†Ÿçš„æœ‹å‹ï¼Œå¯ä»¥å» github ä¸Šå­¦ä¹ ä¸€æ³¢Â [ä¼ é€é—¨](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fsquare%2Fjavapoet)ï¼Œè¿™é‡Œæˆ‘ä»¬ä»‹ç»ä¸€ä¸‹å®ƒå¸¸ç”¨çš„ä¸€äº›ç±»ï¼š
    
    > TypeSpecï¼šç”¨äºç”Ÿæˆç±»ã€æ¥å£ã€æšä¸¾å¯¹è±¡çš„ç±»
    > 
    > 
    > MethodSpecï¼šç”¨äºç”Ÿæˆæ–¹æ³•å¯¹è±¡çš„ç±»
    > 
    > ParameterSpecï¼šç”¨äºç”Ÿæˆå‚æ•°å¯¹è±¡çš„ç±»
    > 
    > AnnotationSpecï¼šç”¨äºç”Ÿæˆæ³¨è§£å¯¹è±¡çš„ç±»
    > 
    > FieldSpecï¼šç”¨äºé…ç½®ç”Ÿæˆæˆå‘˜å˜é‡çš„ç±»
    > 
    > ClassNameï¼šé€šè¿‡åŒ…åå’Œç±»åç”Ÿæˆçš„å¯¹è±¡ï¼Œåœ¨JavaPoetä¸­ç›¸å½“äºä¸ºå…¶æŒ‡å®š Class
    > 
    > ParameterizedTypeNameï¼šé€šè¿‡ MainClass å’Œ IncludeClass ç”ŸæˆåŒ…å«æ³›å‹çš„ Class
    > 
    > JavaFileï¼šæ§åˆ¶ç”Ÿæˆçš„ Java æ–‡ä»¶çš„è¾“å‡ºçš„ç±»
    > 
    
    **å¯¼å…¥ä¾èµ–**
    
    ```kotlin
    implementation 'com.squareup:javapoet:1.13.0'
    ```
    
    **æŒ‰ç…§æŒ‡å®šæ¨¡æ¿ç”ŸæˆJavaç±»æ–‡ä»¶**
    
    åœ¨MainActivityä¸‹é¢è¿›è¡Œæ³¨è§£
    
    ```kotlin
    @AptAnnotation(desc = "æˆ‘åœ¨MainActivity ä¸Šé¢çš„æ³¨è§£")
    public class MainActivity extends AppCompatActivity {
        @AptAnnotation(desc = "æˆ‘åœ¨onCreate ä¸Šé¢çš„æ³¨è§£")
        @Override
        protected void onCreate(Bundle savedInstanceState) {
            super.onCreate(savedInstanceState);
            setContentView(R.layout.activity_main);
        }
    }
    ```
    
    å¸Œæœ›ç”Ÿæˆçš„ä»£ç å¦‚ä¸‹:
    
    ![Untitled](%E6%B3%A8%E8%A7%A3%203754c1f218474b69ac8425aced366de1/Untitled%206.png)
    
    ä»£ç å¦‚ä¸‹:
    
    ```kotlin
    /**
     * æ³¨è§£å¤„ç†å™¨
     */
    @SupportedOptions("MODULE_NAME")
    @AutoService(Processor.class)
    public class AnnotationCompiler extends AbstractProcessor {
    
        @Override
        public Set<String> getSupportedAnnotationTypes() {
            Set<String> types = new HashSet<>();
            types.add("com.dullfan.annotations.AptAnnotation");
            Messager messager = processingEnv.getMessager();
            messager.printMessage(Diagnostic.Kind.WARNING, "Test -> 1111");;
            return types;
        }
    
        /**
         * æ–‡ä»¶ç”Ÿæˆå™¨
         */
        private Filer mFiler;
    
        /**
         * æ¨¡å—åç§°
         */
        private String mModuleName;
    
        Messager messager;
    
        /**
         * åˆå§‹åŒ–
         */
        @Override
        public synchronized void init(ProcessingEnvironment processingEnv) {
            super.init(processingEnv);
            mFiler = processingEnv.getFiler();
            mModuleName = processingEnv.getOptions().get("MODULE_NAME");
            messager = processingEnv.getMessager();
            messager.printMessage(Diagnostic.Kind.NOTE, "æ‰“å°ä¿¡æ¯");
            messager = processingEnv.getMessager();
            messager.printMessage(Diagnostic.Kind.NOTE, "AnnotationCompiler init");
            messager.printMessage(Diagnostic.Kind.NOTE, "MODULE_NAME is " + mModuleName);
        }
    
        /**
         * ç¼–å†™ç”Ÿæˆ Java ç±»çš„ç›¸å…³é€»è¾‘
         *
         * @param annotations æ”¯æŒå¤„ç†çš„æ³¨è§£é›†åˆ
         * @param roundEnv    é€šè¿‡è¯¥å¯¹è±¡æŸ¥æ‰¾æŒ‡å®šæ³¨è§£ä¸‹çš„èŠ‚ç‚¹ä¿¡æ¯
         * @return true: è¡¨ç¤ºæ³¨è§£å·²å¤„ç†ï¼Œåç»­æ³¨è§£å¤„ç†å™¨æ— éœ€å†å¤„ç†å®ƒä»¬ï¼›false: è¡¨ç¤ºæ³¨è§£æœªå¤„ç†ï¼Œå¯èƒ½è¦æ±‚åç»­æ³¨è§£å¤„ç†å™¨å¤„ç†
         */
        @Override
        public boolean process(Set<? extends TypeElement> annotations, RoundEnvironment roundEnv) {
            Messager messager = processingEnv.getMessager();
            messager.printMessage(Diagnostic.Kind.NOTE, "æ‰“å°ä¿¡æ¯");
    
            // è·å–å½“å‰æ³¨è§£ä¸‹çš„èŠ‚ç‚¹ä¿¡æ¯
            Set<? extends Element> elementsAnnotatedWith = roundEnv.getElementsAnnotatedWith(AptAnnotation.class);
    
            // æ„å»ºtest()
            MethodSpec.Builder builder = MethodSpec.methodBuilder("test")
                    .addModifiers(Modifier.PUBLIC)// ä¿®é¥°ç¬¦
                    .returns(void.class) // è¿”å›ç±»å‹
                    .addParameter(String.class, "parm");// å‚æ•°
            builder.addStatement("$T.out.println($S)", System.class, "æ¨¡å—: " + mModuleName);
    
            if (elementsAnnotatedWith != null && !elementsAnnotatedWith.isEmpty()) {
                for (Element element : elementsAnnotatedWith) {
                    // å½“å‰èŠ‚ç‚¹åç§°
                    String elementName = element.getSimpleName().toString();
                    // å½“å‰èŠ‚ç‚¹ä¸‹æ³¨è§£çš„å±æ€§
                    String desc = element.getAnnotation(AptAnnotation.class).desc();
                    // æ„å»ºæ–¹æ³•ä½“
                    builder.addStatement("$T.out.println($S)", System.class, "èŠ‚ç‚¹: " + elementName + "    " + "æè¿°: " + desc);
                }
            }
    
            MethodSpec methodSpec = builder.build();
            TypeSpec typeSpec = TypeSpec.classBuilder("HelloWorld")
                    .addModifiers(Modifier.PUBLIC)
                    .addMethod(methodSpec)
                    .build();
            JavaFile javaFile = JavaFile.builder("com.dullfan.aptannotationdemo", typeSpec).build();
            messager.printMessage(Diagnostic.Kind.NOTE, "æ‰“å°ä¿¡æ¯");
            System.out.println("æ–‡æœ¬");
            try {
                // åˆ›å»ºæ–‡ä»¶
                javaFile.writeTo(mFiler);
            } catch (IOException e) {
                throw new RuntimeException(e);
            }
            return true;
        }
    }
    ```
    

**api è°ƒç”¨ç”Ÿæˆä»£ç å®Œæˆä¸šåŠ¡åŠŸèƒ½**

è¿™ä¸ª Module çš„æ“ä½œç›¸å¯¹æ¥è¯´ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯é€šè¿‡åå°„è·å–åˆ°ç”Ÿæˆçš„ç±»ï¼Œè¿›è¡Œç›¸åº”çš„å°è£…ä½¿ç”¨å³å¯ï¼Œç¼–å†™å¦‚ä¸‹ï¼š

```kotlin
public class MyAptApi {
    @SuppressWarnings("all")
    public static void init(){
        try {
            Class<?> aClass = Class.forName("com.dullfan.aptannotationdemo.HelloWorld");
            Constructor<?> declaredConstructor = aClass.getDeclaredConstructor();
            Object o = declaredConstructor.newInstance();
            Method test = aClass.getDeclaredMethod("test", String.class);
            test.invoke(o,"å‚æ•°å€¼");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

æ¥ç€åœ¨ MainActivity çš„ oncreate æ–¹æ³•é‡Œé¢è¿›è¡Œè°ƒç”¨ï¼š

```kotlin
@AptAnnotation(desc = "æˆ‘æ˜¯ MainActivity ä¸Šé¢çš„æ³¨è§£")
public class MainActivity extends AppCompatActivity {
  
    @AptAnnotation(desc = "æˆ‘æ˜¯ onCreate ä¸Šé¢çš„æ³¨è§£")
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        MyAptApi.init();
    }
}
//æ‰“å°ç»“æœ
æ¨¡å—: app
èŠ‚ç‚¹: MainActivity  æè¿°: æˆ‘æ˜¯ MainActivity ä¸Šé¢çš„æ³¨è§£
èŠ‚ç‚¹: onCreate  æè¿°: æˆ‘æ˜¯ onCreate ä¸Šé¢çš„æ³¨è§£
```

**å°é—®é¢˜**

**ç¬¬ä¸€ä¸ªé—®é¢˜**

å¦‚æœæ‰“å°çš„ä¿¡æ¯æ˜¯ä¹±ç ï¼Œé‚£ä¹ˆåœ¨Android Studioçš„Help -> Edit Custom VM Optionsâ€¦ æ‰“å¼€çš„é…ç½®æ–‡ä»¶ä¸­åŠ å…¥ï¼š

```java
-Dconsole.encoding=UTF-8
-Dfile.encoding=UTF-8
```

ç„¶åé‡å¯å³å¯ã€‚

**ç¬¬äºŒä¸ªé—®é¢˜**

é‚£ä¹ˆç°åœ¨è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ³¨è§£å¤„ç†å™¨ä¸­processæ–¹æ³•ä¸ºä»€ä¹ˆä¼šæ‰§è¡Œå¤šæ¬¡ï¼Ÿ

Javacå°†æˆ‘ä»¬çš„æºæ–‡ä»¶ç¼–è¯‘æˆclassæ–‡ä»¶è¦ç»è¿‡ä»¥ä¸‹æ­¥éª¤

![https://cdn.nlark.com/yuque/0/2022/png/26240361/1645678980461-58cfc7eb-20a6-4f36-909f-f7b1bd5db8d0.png](https://cdn.nlark.com/yuque/0/2022/png/26240361/1645678980461-58cfc7eb-20a6-4f36-909f-f7b1bd5db8d0.png)

åœ¨æ³¨è§£å¤„ç†ç¯èŠ‚ï¼Œå¯èƒ½ä¼šå°†ä¹‹å‰çš„Javaæºæ–‡ä»¶æ”¹æ‰æˆ–è€…ç”Ÿæˆä¸€ä¸ªæ–°çš„Javaæºæ–‡ä»¶ã€‚ä¸ç®¡æ˜¯æ”¹å˜è¿˜æ˜¯æ–°å¢éƒ½ä¼šå†æ¬¡ç»å†Javacã€‚æ‰€ä»¥å°±æ‰§è¡Œäº†ä¸¤æ¬¡ã€‚åªéœ€è¦åˆ¤æ–­`set`æ˜¯å¦ä¸ºç©º

```java
@Override
public boolean process(Set<? extends TypeElement> set, RoundEnvironment roundEnvironment) {
    if(set.isEmpty()){
        Messager messager = processingEnv.getMessager();
        messager.printMessage(Diagnostic.Kind.NOTE,"æ³¨è§£");
    }
    return true;
}
```

![Untitled](%E6%B3%A8%E8%A7%A3%203754c1f218474b69ac8425aced366de1/Untitled%207.png)



